#!/bin/bash
#
# Usage
#   redmine edit [options] <ticket_id>
#
# Description
#
# Options
#   -f            force update (upload draft.md even if there's update on server: FORCE_UPDATE)
#   -n            no download and edit with local cache (NO_DOWNLOAD)
#   -h            show this message
#
# TODO:
#  - local ticket の場合、upload 処理が $RM_CONFIG/edit_memo 配下にアップロードすることとする。

show_help() {
	sed -n 2,$[$BASH_LINENO-4]p $BASH_SOURCE | grep "^#" | sed 's/^#/ /'
}

while [[ $# -gt 0 ]] ; do
	key="$1"
	case $key in
		-n)
			NO_DOWNLOAD=true
			shift 1
			;;
		-f)
			FORCE_UPDATE=true
			shift 1
			;;
		-h)
			show_help
			exit 0
			;;
		*)
			break
			;;
	esac
done

ISSUEID=$1

if ! check_ticket_id_format $ISSUEID ; then
	echo "invalid issueid format" >&2
	exit 1
fi

if [[ "$ISSUEID" =~ ^L ]] ; then
	edit_local_ticket $ISSUEID
	exit 0
fi

update_local_cache || exit 1

update_issue3 $ISSUEID
